# index generation
sh target/appassembler/bin/IndexCollection \
  -collection Cord19AbstractCollection -generator Cord19Generator  \
  -threads 8 -input /m/infochain/lukuang/CORD-19/data/covid-2020-05-01 \
  -index /m/infochain/lukuang/shared_for_round2/anserini/index/title+abstract \
  -storePositions -storeDocvectors -storeContents -storeRaw > log.covid-2020-05-10.title+abstract.txt


#get initial PRF retrieval results with the best parameters for round1
target/appassembler/bin/SearchCollection -index index/title+abstract \
 -topicreader Covid -topics src/main/resources/topics-and-qrels/topics.covid-round2-udel.xml \
 -topicfield query -f2exp -f2exp.s 0.8 -axiom -axiom.deterministic -axiom.top 10 -axiom.beta 0.7 \
 -axiom.outputQuery -hits 1400 -output runs/initial_results > logs/run.initial.log

# remove judged documents from PRF
 python scripts/remove_judged.py --qrels src/main/resources/topics-and-qrels/qrels.covid-round1.txt --input runs/initial_results --output runs/initial_results_for_rerank


# evaluate based on round1 qrels
 eval/trec_eval.9.0.4/trec_eval -m ndcg_cut.10 src/main/resources/topics-and-qrels/qrels.covid-round1.txt runs/initial_results

# get most relevant documents for each query, if there are less than 20, add less relevant documents until there are 20
python scripts/get_most_rel_docids.py src/main/resources/topics-and-qrels/qrels.covid-round1.txt most_rel_docids_10/ --need 20

# generate initial rf run with the relevant documents got above using best beta and s, NOTE THAT WE USE ROUND 1 QUERY HERE:
 target/appassembler/bin/SearchCollection -index index/title+abstract  \
 -topicreader Covid -topics src/main/resources/topics-and-qrels/topics.covid-round1-udel.xml \
 -topicfield query -f2exp -f2exp.s 0.4 -axiom -axiom.deterministic -axiom.top 10 -axiom.beta 1.1 \
-axiom.rf_doc_path most_rel_docids_20 -axiom.outputQuery \
-hits 1400 -output runs/most_rel_doc_20_rf > logs/run.most_rel_doc_20_rf.log

# remove judged documents from rf results
 python scripts/remove_judged.py --qrels src/main/resources/topics-and-qrels/qrels.covid-round1.txt --input runs/most_rel_doc_20_rf --output runs/most_rel_doc_20_rf_for_rerank

 # merge RF results for round 1 queries with PRF results for round 2 queries
 python scripts/merge_results.py --round1_input  runs/most_rel_doc_20_rf_for_rerank  --round2_input  runs/initial_results_for_rerank --runtag udel_fang_feedback --output runs/udel_fang_feedback

 # sanity check the generated run
 perl  scripts/check_run.pl runs/udel_fang_feedback
